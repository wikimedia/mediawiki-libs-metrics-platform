# Autogenerated by pipeline-to-gitlab
include:
  - project: 'repos/releng/kokkuri'
    file: 'includes/images.yaml'

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - test
  - deploy

.test-client:
  # Job template: all client library tests
  extends: .kokkuri:build-and-run-image
  stage: test
  variables:
    BUILD_VARIANT: test

test-java:
  stage: test
  # Run tests for Java client library
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - .mvn/**/*
        - java/**/*
        - mvnw
        - mvwn.cmnd
  trigger:
    strategy: depend
    include:
      - component: $CI_SERVER_FQDN/repos/maven/wmf-maven-ci/mvn-job-verify@2.1.2
        inputs:
          pom-dir: java
          workflow-rules:
            - if: $CI_PIPELINE_SOURCE == "parent_pipeline"

test-js:
  # Run tests for Javascript client library
  extends: .test-client
  rules:
    - changes:
        - js/**/*
  variables:
    BUILD_CONTEXT: js

.test-client-php:
  # Job template: PHP client library tests
  extends: .test-client
  rules:
    - changes:
        - .phan/**/*
        - .pipeline/blubber-php.yaml
        - php/**/*
        - tests/consistency/*.php
        - tests/consistency/php/*
        - .phpcs.xml
        - composer.json
        - composer.lock
  variables:
    BUILD_CONFIG: .pipeline/blubber-php.yaml
    # Use the job name as the blubber build variant
    BUILD_VARIANT: "${CI_JOB_NAME}"

test-php81:
  # Run tests for PHP client library with PHP 8.1 runtime
  extends: .test-client-php

test-php83:
  # Run tests for PHP client library with PHP 8.3 runtime
  extends: .test-client-php

test-swift:
  extends: .test-client
  rules:
    - changes:
        - swift/**/*
  variables:
    BUILD_CONTEXT: swift
